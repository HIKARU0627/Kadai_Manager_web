// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  username     String     @unique
  email        String     @unique
  passwordHash String
  fullName     String?
  tactCookie   String?    // TACT (Sakai) authentication cookie
  lastSyncAt   DateTime?  // Last sync timestamp from TACT
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  subjects     Subject[]
  tasks        Task[]
  events       Event[]
  notes        Note[]
  files        File[]
  reminders    Reminder[]
  semesters    Semester[]
  periods      Period[]
  eventTypes   EventTypeConfig[]

  @@map("users")
}

model Subject {
  id          String   @id @default(cuid())
  userId      String
  semesterId  String?
  name        String
  type        String   @default("regular") // regular, intensive, on_demand, other
  teacher     String?
  classroom   String?
  dayOfWeek   Int?     // 0=日曜, 1=月曜, ..., 6=土曜 (regularの場合のみ)
  period      Int?     // 時限 (regularの場合のみ)
  color       String   @default("#3B82F6")
  sakaiId     String?  // Sakai site ID for synced subjects
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  semester    Semester? @relation(fields: [semesterId], references: [id], onDelete: SetNull)
  tasks       Task[]
  events      Event[]
  notes       Note[]
  files       File[]

  @@unique([userId, sakaiId])
  @@map("subjects")
}

model Task {
  id          String    @id @default(cuid())
  userId      String
  subjectId   String?
  title       String
  description String?
  dueDate     DateTime
  status      String    @default("not_started") // not_started, in_progress, completed
  priority    Int       @default(0) // 0=低, 1=中, 2=高
  taskType    String    @default("assignment") // assignment, quiz
  sakaiId     String?   // Sakai assignment ID for synced tasks
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     Subject?  @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  files       File[]
  reminders   Reminder[]

  @@unique([userId, sakaiId])
  @@map("tasks")
}

model Event {
  id            String     @id @default(cuid())
  userId        String
  subjectId     String?
  title         String
  description   String?
  eventType     String     @default("event") // event, test
  startDatetime DateTime
  endDatetime   DateTime
  location      String?
  color         String     @default("#10B981")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject       Subject?   @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  reminders     Reminder[]

  @@map("events")
}

model Note {
  id        String    @id @default(cuid())
  userId    String
  subjectId String
  title     String?
  content   String
  noteType  String    @default("general") // general, announcement
  sakaiId   String?   // Sakai announcement ID for synced announcements
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  files     File[]
  reminders Reminder[]

  @@unique([userId, sakaiId])
  @@map("notes")
}

model File {
  id        String   @id @default(cuid())
  userId    String
  taskId    String?
  noteId    String?
  subjectId String?
  fileName  String
  filePath  String?
  fileUrl   String?
  fileType  String?
  fileSize  Int?
  sakaiRef  String?  // Sakai file reference for synced files
  sakaiUrl  String?  // Original Sakai URL for direct access
  fileSource String? @default("local") // local, sakai_assignment, sakai_submission
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  note      Note?    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("files")
}

model Reminder {
  id               String   @id @default(cuid())
  userId           String
  taskId           String?
  eventId          String?
  noteId           String?
  reminderDatetime DateTime
  isSent           Boolean  @default(false)
  notificationType String   @default("app") // app, email, push
  createdAt        DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task             Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  event            Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  note             Note?    @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@map("reminders")
}

model Semester {
  id        String    @id @default(cuid())
  userId    String
  year      Int       // 年度 (例: 2024, 2025)
  name      String    // 学期名 (例: "春1期", "秋2期")
  startDate DateTime? // 開始日
  endDate   DateTime? // 終了日
  isActive  Boolean   @default(false) // 現在の学期かどうか
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects  Subject[]

  @@map("semesters")
}

model Period {
  id           String   @id @default(cuid())
  userId       String
  periodNumber Int      // 時限番号 (1, 2, 3, 4, 5, ...)
  startTime    String   // HH:mm format (例: "09:00")
  endTime      String   // HH:mm format (例: "10:30")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodNumber])
  @@map("periods")
}

model EventTypeConfig {
  id              String   @id // event, test, またはカスタムID
  userId          String
  name            String   // 表示名 (例: "予定", "テスト")
  color           String   // 色 (例: "#10B981")
  requiresSubject Boolean  @default(false) // 科目が必須かどうか
  isDefault       Boolean  @default(false) // デフォルト項目 (削除不可)
  order           Int      // 表示順序
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, id])
  @@map("event_type_configs")
}
